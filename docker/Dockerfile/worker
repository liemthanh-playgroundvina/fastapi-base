FROM python:3.9 as builder
WORKDIR /app

COPY worker/requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt


FROM nvidia/cuda:11.8.0-runtime-ubuntu20.04

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TZ=Etc/UTC \
    DEBIAN_FRONTEND=noninteractive \
    PATH=/root/.local/bin:$PATH

RUN apt-get update && apt-get install -yq --no-install-recommends \
    wget curl \
    python3.9 python3.9-distutils \
    build-essential libc6 \
    libmagic-dev poppler-utils tesseract-ocr libreoffice \
    && apt-get clean autoclean \
    && apt-get autoremove --yes \
    && rm -rf /var/lib/{apt,dpkg,cache,log}/

RUN wget https://bootstrap.pypa.io/get-pip.py && \
    python3.9 get-pip.py && rm get-pip.py
RUN ln -s /usr/bin/python3.9 /usr/local/bin/python && \
    ln -s /usr/local/bin/pip /usr/local/bin/pip3.9

WORKDIR /app

COPY --from=builder /root/.local /root/.local

COPY ./app /app/app
COPY ./worker /app/worker
COPY ./static /app/static
COPY ./tests /app/tests
COPY ./logs /app/logs
RUN touch logs/celery.log

CMD ["scripts/entrypoint.worker.sh"]