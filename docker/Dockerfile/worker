FROM python:3.9 as builder
WORKDIR /app

COPY worker/requirements.txt .
RUN pip install --user --no-cache-dir -r requirements.txt

FROM nvidia/cuda:11.8.0-runtime-ubuntu20.04

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    TZ=Etc/UTC \
    DEBIAN_FRONTEND=noninteractive \
    PATH=/root/.local/bin:$PATH \
    PYTHONPATH=/root/.local/lib/python3.9/site-packages:$PYTHONPATH

RUN apt-get update && apt-get install -yq --no-install-recommends \
    wget curl \
    python3.9 python3.9-distutils \
    build-essential libc6 \
    libmagic-dev poppler-utils tesseract-ocr libreoffice \
    && curl -sS https://bootstrap.pypa.io/get-pip.py | python3.9 \
    && apt-get clean autoclean \
    && apt-get autoremove --yes \
    && rm -rf /var/lib/{apt,dpkg,cache,log}/

COPY --from=builder /root/.local /root/.local

WORKDIR /app

COPY ./app /app/app
COPY ./worker /app/worker
COPY ./static /app/static
COPY ./tests /app/tests
COPY ./logs /app/logs
COPY ./scripts /app/scripts
RUN touch logs/celery.log

RUN chmod +x /app/scripts/entrypoint.worker.sh

CMD ["/app/scripts/entrypoint.worker.sh"]
