FROM nvidia/cuda:11.8.0-cudnn8-devel-ubuntu20.04 AS builder

WORKDIR /app

COPY worker/requirements.txt .

RUN apt-get update && apt-get install -y \
    build-essential libc6 \
    libmagic-dev poppler-utils tesseract-ocr libreoffice \
    && apt-get clean autoclean \
    && apt-get autoremove --yes \
    && rm -rf /var/lib/{apt,dpkg,cache,log}/

RUN pip install --no-cache-dir -r requirements.txt


FROM nvidia/cuda:11.8.0-runtime-ubuntu20.04

WORKDIR /app

COPY --from=builder /usr/local /usr/local
COPY --from=builder /app /app

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

COPY ./app /app/app
COPY ./worker /app/worker
COPY ./static /app/static
COPY ./tests /app/tests
COPY ./logs /app/logs
RUN touch logs/celery.log

CMD ["scripts/entrypoint.worker.sh"]